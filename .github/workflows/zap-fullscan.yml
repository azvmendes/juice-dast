name: ZAP Full Scan DAST (Staging)

on:
  schedule:
    # Executa todos os dias às 2h da manhã UTC (ajuste o horário se quiser)
    - cron: '0 2 * * *'
  workflow_dispatch: # Mantém a opção de rodar manualmente
  push:
    branches:
      - main

jobs:
  zap-fullscan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start staging environment
        run: |
          docker compose -f docker/docker-compose.staging.yml up -d
          sleep 15

      - name: Run ZAP Full Scan
        env:
          ZAP_USERNAME: ${{ secrets.JUICE_ADMIN_USER }}
          ZAP_PASSWORD: ${{ secrets.JUICE_ADMIN_PASS }}
        run: |
          mkdir -p zap-wrk
          chmod 777 zap-wrk

          docker run \
            --network="host" \
            -e ZAP_USERNAME="$ZAP_USERNAME" \
            -e ZAP_PASSWORD="$ZAP_PASSWORD" \
            -v "$(pwd):/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
              -t "http://localhost:3002" \
              -n ".zap/juice.context" \
              -I \
              --hook=".zap/hooks/session-keeper.py" \
              -r "zap-wrk/fullscan-report.html" \
              -x "zap-wrk/zap-fullscan-report.xml" \
              -J "zap-wrk/zap-fullscan-report.json" \
              -z " -config context.authenticate=true -config context.activeContext=0 -config auth.username=${ZAP_USERNAME} -config auth.password=${ZAP_PASSWORD}"

      - name: Upload ZAP Full Scan Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zap-fullscan-results
          path: zap-wrk/

      - name: Stop DEV environment
        if: always()
        run: docker compose -f docker/docker-compose.staging.yml down