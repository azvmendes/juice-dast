name: ZAP Full Scan

on:
  workflow_dispatch:
  push:
    branches:
      - main
  # Opcional: agendar scans periódicos
  schedule:
    - cron: '0 3 * * *' # todos os dias às 03h UTC

jobs:
  zap_full_scan:
    runs-on: ubuntu-latest

    env:
      ZAP_TARGET: "http://localhost:3002"
      ZAP_USERNAME: ${{ secrets.JUICE_ADMIN_USER }}
      ZAP_PASSWORD: ${{ secrets.JUICE_ADMIN_PASS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Cria o script de autenticação para o ZAP (form-based)
      - name: Create ZAP authentication script
        run: |
          cat <<EOF > juice-auth.js
          function authenticate(context, user, password) {
            var HttpRequestHeader = Java.type('org.parosproxy.paros.network.HttpRequestHeader');
            var HttpHeader = Java.type('org.parosproxy.paros.network.HttpHeader');
            var URI = Java.type('org.apache.commons.httpclient.URI');
            var requestBody = 'email=' + encodeURIComponent(user) + '&password=' + encodeURIComponent(password);
            var request = new org.parosproxy.paros.network.HttpMessage();
            request.setRequestHeader(new HttpRequestHeader(
              HttpRequestHeader.POST,
              new URI('${{ env.ZAP_TARGET }}/rest/user/login', false),
              HttpHeader.HTTP11));
            request.setRequestBody(requestBody);
            request.getRequestHeader().setContentLength(requestBody.length);
            request.getRequestHeader().setHeader(HttpHeader.CONTENT_TYPE, 'application/x-www-form-urlencoded');
            return request;
          }
          EOF

      # Executa o ZAP Full Scan com autenticação
      - name: ZAP Full Scan with Auth
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: ${{ env.ZAP_TARGET }}
          fail_action: false
          allow_issue_writing: false
          cmd_options: >
            -z "-config replacer.full_list(0).description=authheader
                 -config replacer.full_list(0).enabled=true
                 -config replacer.full_list(0).matchtype=REQ_HEADER
                 -config replacer.full_list(0).matchregex=false
                 -config replacer.full_list(0).matchstring=Cookie
                 -config replacer.full_list(0).replacement=
                 -config replacer.full_list(0).initiators=16"
            --context-file juice-context.context
            --auth-script juice-auth.js
            --auth-user ${{ env.ZAP_USERNAME }}
            --auth-pass ${{ env.ZAP_PASSWORD }}
            --ajaxSpider

      # Publica o relatório como artefato do workflow
      - name: Upload ZAP Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-results
          path: zap-wrk/