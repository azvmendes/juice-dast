name: ZAP Full Scan (Staging)

on:
  schedule:
    - cron: "0 3 * * *" # roda diariamente às 03:00 UTC
  workflow_dispatch:

jobs:
  zap-full-scan:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1. Checkout do repositório
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2. Subir ambiente STAGING
      # -------------------------------
      - name: Start Staging environment
        run: |
          docker compose -f docker/docker-compose.staging.yml up -d
          sleep 15

      # -------------------------------
      # 3. Criar diretório para relatórios
      # -------------------------------
      - name: Prepare ZAP working directory
        run: |
          mkdir -p zap-wrk
          chmod 777 zap-wrk

      # -------------------------------
      # 4. Executar ZAP FULL SCAN
      # -------------------------------
      - name: Run ZAP Full Scan
        env:
          ZAP_USERNAME: ${{ secrets.JUICE_ADMIN_USER }}
          ZAP_PASSWORD: ${{ secrets.JUICE_ADMIN_PASS }}
        run: |
          docker run \
            --network="host" \
            -v $(pwd)/.zap:/zap/wrk \
            -v $(pwd)/zap-wrk:/zap/wrk/output \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
              -t http://localhost:3002 \
              -c juice.context \
              -I \
              --hook=/zap/wrk/hooks/session-keeper.py \
              -r fullscan-report.html \
              -x fullscan-report.xml \
              -J fullscan-report.json \
              -z "
                -config context.authenticate=true
                -config context.activeContext=0
                -config context.loadContext=/zap/wrk/juice.context
                -config auth.username='${ZAP_USERNAME}'
                -config auth.password='${ZAP_PASSWORD}'
              "


      # -------------------------------
      # 5. Upload dos relatórios como artifacts
      # -------------------------------
      - name: Upload ZAP Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zap-fullscan-results
          path: zap-wrk/

      # -------------------------------
      # 6. Teardown do ambiente
      # -------------------------------
      - name: Shutdown Staging Environment
        if: always()
        run: |
          docker compose -f docker/docker-compose.staging.yml down
